version: '3.8'

services:
  # Control Server
  control-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.control
    ports:
      - "8443:8443"
    volumes:
      - ./certs:/app/certs:ro
      - ./configs/control-server.yaml:/app/configs/control-server.yaml:ro
      - tunnel-data:/app/data
      - tunnel-logs:/app/logs
    environment:
      - TLS_CERT_FILE=/app/certs/server.crt
      - TLS_KEY_FILE=/app/certs/server.key
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
    restart: unless-stopped
    networks:
      - tunnel-network

  # Example Agent 1 (Web Service)
  agent-web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - ./certs:/app/certs:ro
      - ./configs/agent-web.yaml:/app/configs/agent.yaml:ro
    environment:
      - CONTROL_SERVER_URL=wss://control-server:8443
      - AGENT_TOKEN=${AGENT_WEB_TOKEN}
    depends_on:
      - control-server
    restart: unless-stopped
    networks:
      - tunnel-network

  # Example Agent 2 (Database)
  agent-db:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    volumes:
      - ./certs:/app/certs:ro
      - ./configs/agent-db.yaml:/app/configs/agent.yaml:ro
    environment:
      - CONTROL_SERVER_URL=wss://control-server:8443
      - AGENT_TOKEN=${AGENT_DB_TOKEN}
    depends_on:
      - control-server
    restart: unless-stopped
    networks:
      - tunnel-network

  # Nginx Reverse Proxy (optional)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - control-server
    restart: unless-stopped
    networks:
      - tunnel-network

networks:
  tunnel-network:
    driver: bridge

volumes:
  tunnel-data:
  tunnel-logs: