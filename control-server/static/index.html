<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunnel Control Server Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: #333;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-online {
            background-color: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }
        
        .status-offline {
            background-color: rgba(247, 37, 133, 0.1);
            color: #f72585;
        }
        
        .status-degraded {
            background-color: rgba(248, 150, 30, 0.1);
            color: #f8961e;
        }
        
        .service-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .tunnel-card {
            border-left: 4px solid var(--success-color);
        }
        
        .metric-card {
            text-align: center;
            padding: 20px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .service-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .service-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .service-item:hover {
            background-color: #f8f9fa;
        }
        
        .port-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-right: 5px;
        }
        
        .connection-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .connection-active {
            background-color: #4cc9f0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .connection-inactive {
            background-color: #6c757d;
        }
        
        .btn-tunnel {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 12px;
            color: white;
        }
        
        .refresh-btn {
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-network-wired me-2"></i>
                Tunnel Control Server
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3" id="currentTime">--:--:--</span>
                <span class="badge bg-light text-dark" id="serverStatus">
                    <i class="fas fa-circle me-1"></i> Loading...
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Metrics Row -->
        <div class="row">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="totalServices">0</div>
                    <div class="metric-label">Total Services</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="onlineServices">0</div>
                    <div class="metric-label">Online Services</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="activeTunnels">0</div>
                    <div class="metric-label">Active Tunnels</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="metric-value" id="totalConnections">0</div>
                    <div class="metric-label">Total Connections</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row mt-4">
            <!-- Services List -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Registered Services</span>
                        <div>
                            <i class="fas fa-sync-alt refresh-btn me-3" onclick="loadServices()" title="Refresh"></i>
                            <button class="btn btn-sm btn-primary" onclick="showAddServiceModal()">
                                <i class="fas fa-plus me-1"></i> Add Service
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Service ID</th>
                                        <th>Name</th>
                                        <th>Hostname</th>
                                        <th>Ports</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="servicesTable">
                                    <!-- Services will be populated here -->
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Loading services...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Active Tunnels -->
                <div class="card mt-4">
                    <div class="card-header">
                        <span>Active Tunnels</span>
                    </div>
                    <div class="card-body">
                        <div id="tunnelsContainer">
                            <p class="text-muted">No active tunnels</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Info & Quick Actions -->
            <div class="col-md-4">
                <!-- System Status -->
                <div class="card">
                    <div class="card-header">
                        <span>System Status</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Control Server</small>
                            <div class="d-flex justify-content-between">
                                <span>Uptime</span>
                                <span id="serverUptime">0d 0h 0m</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Version</span>
                                <span id="serverVersion">1.0.0</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Memory Usage</small>
                            <div class="progress" style="height: 10px;">
                                <div id="memoryProgress" class="progress-bar bg-success" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="memoryText">0 MB / 0 MB</small>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">CPU Usage</small>
                            <div class="progress" style="height: 10px;">
                                <div id="cpuProgress" class="progress-bar bg-info" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="cpuText">0%</small>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <span>Quick Actions</span>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="createTunnel()">
                                <i class="fas fa-link me-2"></i> Create Tunnel
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportConfig()">
                                <i class="fas fa-download me-2"></i> Export Config
                            </button>
                            <button class="btn btn-outline-info" onclick="showLogs()">
                                <i class="fas fa-file-alt me-2"></i> View Logs
                            </button>
                            <button class="btn btn-outline-warning" onclick="restartServices()">
                                <i class="fas fa-redo me-2"></i> Restart All
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="card mt-4">
                    <div class="card-header">
                        <span>Recent Activity</span>
                    </div>
                    <div class="card-body">
                        <div id="activityLog" class="service-list">
                            <div class="activity-item">
                                <small class="text-muted">Just now</small>
                                <p class="mb-1">System initialized</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Service Modal -->
    <div class="modal fade" id="addServiceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register New Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="serviceForm">
                        <div class="mb-3">
                            <label class="form-label">Service ID</label>
                            <input type="text" class="form-control" id="serviceId" required>
                            <small class="form-text text-muted">Unique identifier for the service</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Service Name</label>
                            <input type="text" class="form-control" id="serviceName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Hostname</label>
                            <input type="text" class="form-control" id="serviceHostname" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ports</label>
                            <input type="text" class="form-control" id="servicePorts" required>
                            <small class="form-text text-muted">Comma-separated list of ports (e.g., 3000,8080,5432)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Token</label>
                            <input type="text" class="form-control" id="serviceToken" required>
                            <small class="form-text text-muted">Authentication token for the service</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="registerService()">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tunnel Modal -->
    <div class="modal fade" id="createTunnelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Tunnel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tunnelForm">
                        <div class="mb-3">
                            <label class="form-label">Service</label>
                            <select class="form-select" id="tunnelService" required>
                                <option value="">Select a service...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Target Port</label>
                            <input type="number" class="form-control" id="tunnelPort" required min="1" max="65535">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Protocol</label>
                            <select class="form-select" id="tunnelProtocol">
                                <option value="http">HTTP</option>
                                <option value="tcp">TCP</option>
                                <option value="https">HTTPS</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Timeout (seconds)</label>
                            <input type="number" class="form-control" id="tunnelTimeout" value="30">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitTunnel()">Create Tunnel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Global variables
        let services = [];
        let tunnels = [];
        let activityLog = [];
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateClock();
            setInterval(updateClock, 1000);
            
            loadServices();
            loadSystemStatus();
            
            // Auto-refresh every 30 seconds
            setInterval(loadServices, 30000);
            setInterval(loadSystemStatus, 10000);
        });
        
        // Update clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('currentTime').textContent = timeString;
        }
        
        // Load services from API
        async function loadServices() {
            try {
                const response = await fetch('/api/v1/services');
                if (!response.ok) throw new Error('Failed to load services');
                
                services = await response.json();
                updateServicesTable();
                updateMetrics();
                updateTunnelServiceDropdown();
            } catch (error) {
                console.error('Error loading services:', error);
                showNotification('Failed to load services: ' + error.message, 'danger');
            }
        }
        
        // Update services table
        function updateServicesTable() {
            const tbody = document.getElementById('servicesTable');
            tbody.innerHTML = '';
            
            if (services.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No services registered
                        </td>
                    </tr>
                `;
                return;
            }
            
            services.forEach(service => {
                const statusClass = getStatusClass(service.status);
                const lastSeen = new Date(service.last_seen).toLocaleTimeString();
                const portsHtml = service.ports ? service.ports.map(p => 
                    `<span class="port-badge">${p.port}/${p.protocol}</span>`
                ).join('') : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${service.status}
                        </span>
                    </td>
                    <td>
                        <code>${service.id}</code>
                    </td>
                    <td>${service.name}</td>
                    <td>${service.hostname}</td>
                    <td>${portsHtml}</td>
                    <td>${lastSeen}</td>
                    <td>
                        <button class="btn btn-sm btn-tunnel" onclick="createTunnelForService('${service.id}')">
                            <i class="fas fa-link"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteService('${service.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Get status CSS class
        function getStatusClass(status) {
            switch(status.toLowerCase()) {
                case 'online': return 'status-online';
                case 'offline': return 'status-offline';
                case 'degraded': return 'status-degraded';
                default: return 'status-offline';
            }
        }
        
        // Update metrics
        function updateMetrics() {
            const total = services.length;
            const online = services.filter(s => s.status === 'online').length;
            
            document.getElementById('totalServices').textContent = total;
            document.getElementById('onlineServices').textContent = online;
            
            // Update server status badge
            const statusBadge = document.getElementById('serverStatus');
            statusBadge.innerHTML = total > 0 
                ? `<i class="fas fa-circle text-success me-1"></i> Running`
                : `<i class="fas fa-circle text-danger me-1"></i> No Services`;
        }
        
        // Update tunnel service dropdown
        function updateTunnelServiceDropdown() {
            const select = document.getElementById('tunnelService');
            select.innerHTML = '<option value="">Select a service...</option>';
            
            services.filter(s => s.status === 'online').forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name} (${service.id})`;
                select.appendChild(option);
            });
        }
        
        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/v1/health');
                if (!response.ok) throw new Error('Failed to load system status');
                
                const data = await response.json();
                
                // Update uptime (mock - in real app, get from server)
                const uptime = Math.floor(Math.random() * 100);
                document.getElementById('serverUptime').textContent = 
                    `${Math.floor(uptime/24)}d ${uptime%24}h 0m`;
                
                // Update memory (mock)
                const memoryUsed = Math.floor(Math.random() * 80) + 10;
                document.getElementById('memoryProgress').style.width = `${memoryUsed}%`;
                document.getElementById('memoryText').textContent = 
                    `${memoryUsed}%`;
                
                // Update CPU (mock)
                const cpuUsed = Math.floor(Math.random() * 70) + 5;
                document.getElementById('cpuProgress').style.width = `${cpuUsed}%`;
                document.getElementById('cpuText').textContent = `${cpuUsed}%`;
                
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }
        
        // Show add service modal
        function showAddServiceModal() {
            const modal = new bootstrap.Modal(document.getElementById('addServiceModal'));
            modal.show();
        }
        
        // Register new service
        async function registerService() {
            const serviceId = document.getElementById('serviceId').value;
            const serviceName = document.getElementById('serviceName').value;
            const hostname = document.getElementById('serviceHostname').value;
            const ports = document.getElementById('servicePorts').value;
            const token = document.getElementById('serviceToken').value;
            
            try {
                const response = await fetch('/api/v1/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        service_id: serviceId,
                        service_name: serviceName,
                        hostname: hostname,
                        ports: ports.split(',').map(p => ({
                            port: parseInt(p.trim()),
                            protocol: 'tcp',
                            name: `Port ${p.trim()}`,
                            internal: true
                        }))
                    })
                });
                
                if (!response.ok) throw new Error('Registration failed');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('addServiceModal'));
                modal.hide();
                
                showNotification('Service registered successfully', 'success');
                loadServices();
                
                // Clear form
                document.getElementById('serviceForm').reset();
                
            } catch (error) {
                showNotification('Failed to register service: ' + error.message, 'danger');
            }
        }
        
        // Delete service
        async function deleteService(serviceId) {
            if (!confirm(`Are you sure you want to delete service ${serviceId}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/services/${serviceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer admin-token'
                    }
                });
                
                if (!response.ok) throw new Error('Deletion failed');
                
                showNotification('Service deleted successfully', 'success');
                loadServices();
                
            } catch (error) {
                showNotification('Failed to delete service: ' + error.message, 'danger');
            }
        }
        
        // Show create tunnel modal
        function createTunnel(serviceId = null) {
            if (serviceId) {
                document.getElementById('tunnelService').value = serviceId;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('createTunnelModal'));
            modal.show();
        }
        
        // Create tunnel for specific service
        function createTunnelForService(serviceId) {
            createTunnel(serviceId);
        }
        
        // Submit tunnel creation
        async function submitTunnel() {
            const serviceId = document.getElementById('tunnelService').value;
            const port = parseInt(document.getElementById('tunnelPort').value);
            const protocol = document.getElementById('tunnelProtocol').value;
            const timeout = parseInt(document.getElementById('tunnelTimeout').value);
            
            if (!serviceId || !port) {
                showNotification('Please fill all required fields', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/v1/tunnel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer admin-token'
                    },
                    body: JSON.stringify({
                        service_id: serviceId,
                        target_port: port,
                        protocol: protocol,
                        timeout: timeout
                    })
                });
                
                if (!response.ok) throw new Error('Tunnel creation failed');
                
                const data = await response.json();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('createTunnelModal'));
                modal.hide();
                
                showNotification(`Tunnel created: ${data.local_addr}`, 'success');
                
                // Add to activity log
                addActivity(`Created tunnel to ${serviceId}:${port}`, 'success');
                
                // Clear form
                document.getElementById('tunnelForm').reset();
                
            } catch (error) {
                showNotification('Failed to create tunnel: ' + error.message, 'danger');
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
            `;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Add activity to log
        function addActivity(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            
            activityLog.unshift({
                time: timeString,
                message: message,
                type: type
            });
            
            // Keep only last 10 activities
            if (activityLog.length > 10) {
                activityLog.pop();
            }
            
            updateActivityLog();
        }
        
        // Update activity log display
        function updateActivityLog() {
            const container = document.getElementById('activityLog');
            container.innerHTML = '';
            
            activityLog.forEach(activity => {
                const item = document.createElement('div');
                item.className = 'activity-item mb-3';
                item.innerHTML = `
                    <small class="text-muted">${activity.time}</small>
                    <p class="mb-1">${activity.message}</p>
                `;
                container.appendChild(item);
            });
        }
        
        // Export configuration
        function exportConfig() {
            const config = {
                timestamp: new Date().toISOString(),
                services: services,
                tunnels: tunnels
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `tunnel-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showNotification('Configuration exported successfully', 'success');
        }
        
        // Show logs (placeholder)
        function showLogs() {
            showNotification('Log viewer not implemented yet', 'info');
        }
        
        // Restart services (placeholder)
        function restartServices() {
            if (confirm('Are you sure you want to restart all services?')) {
                showNotification('Restarting all services...', 'warning');
                // In real app, call API to restart services
            }
        }
    </script>
</body>
</html>